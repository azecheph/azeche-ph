<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin - Votaci√≥n Azeche PH</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #0056B8 0%, #00B853 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1400px; margin: 0 auto; }
.header { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
.logo-text { font-size: 2em; font-weight: 900; }
.logo-blue { color: #0056B8; }
.logo-green { color: #00B853; }
.edificio-info h2 { color: #333; margin-bottom: 5px; }
.edificio-info p { color: #666; font-size: 0.9em; }
.btn-back { background: #0056B8; color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-weight: 600; text-decoration: none; }
.main-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; }
.panel { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.panel h3 { color: #0056B8; margin-bottom: 20px; font-size: 1.5em; display: flex; align-items: center; justify-content: space-between; }
.quorum-display { background: linear-gradient(135deg, #0056B8 0%, #00B853 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; margin: 20px 0; }
.quorum-number { font-size: 4em; font-weight: 900; margin: 10px 0; }
.quorum-label { font-size: 1.2em; opacity: 0.9; }
.qr-section { text-align: center; padding: 20px; background: #f8f9fa; border-radius: 15px; margin: 20px 0; }
.qr-code { width: 250px; height: 250px; background: white; margin: 20px auto; border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 5px solid #0056B8; overflow: hidden; min-height: 250px; }
.qr-code img { width: 100%; height: 100%; object-fit: contain; }
.qr-placeholder { color: #999; padding: 20px; text-align: center; }
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
.stat-box { background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #e9ecef; }
.stat-number { font-size: 2.5em; font-weight: 900; color: #0056B8; }
.stat-label { color: #666; font-size: 0.9em; margin-top: 5px; }
.asistentes-list { max-height: 300px; overflow-y: auto; }
.asistente-item { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
.asistente-nombre { font-weight: 600; color: #333; }
.asistente-apto { color: #666; font-size: 0.9em; }
.asistente-coef { background: #0056B8; color: white; padding: 5px 15px; border-radius: 20px; font-weight: 600; }
.btn-delete-asistente { background: #dc3545; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-left: 10px; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; }
.form-group textarea { min-height: 80px; resize: vertical; }
.btn-crear { background: linear-gradient(135deg, #00B853 0%, #0056B8 100%); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s; }
.btn-crear:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
.votacion-activa { background: linear-gradient(135deg, rgba(0, 184, 83, 0.1) 0%, white 100%); border: 3px solid #00B853; padding: 30px; border-radius: 15px; margin-bottom: 30px; }
.votacion-activa h4 { color: #00B853; font-size: 1.5em; margin-bottom: 15px; }
.resultado-bar { margin-bottom: 15px; }
.resultado-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 600; }
.resultado-nombre { color: #333; }
.resultado-valor { color: #0056B8; }
.progress-bar { height: 40px; background: #e9ecef; border-radius: 20px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(135deg, #00B853 0%, #0056B8 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; transition: width 0.5s ease; }
.btn-cerrar { background: #dc3545; color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 20px; }
.btn-danger { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
.btn-warning { background: #ff9800; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
.no-votacion { text-align: center; padding: 40px; color: #999; }
.admin-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
.error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #f5c6cb; }
.success-message { background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #c3e6cb; }
.loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
@media (max-width: 968px) { .main-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="container">
<div class="header">
<div class="logo-text">
<span class="logo-blue">AZECHE</span><span class="logo-green">PH</span>
</div>
<div class="edificio-info">
<h2 id="edificioNombre">Selecciona edificio</h2>
<p id="fechaAsamblea">Sistema de Votaci√≥n</p>
</div>
<select id="selectEdificio" style="padding: 12px; border-radius: 10px; border: 2px solid #0056B8; font-size: 1em;">
<option value="">Selecciona edificio</option>
<option value="nepal-2">Nepal 2</option>
<option value="avalon">Avalon</option>
<option value="convivienda-1">Convivienda 1</option>
<option value="pinos-del-country">Pinos del Country</option>
            <option value="prueba-asamblea">üß™ PRUEBA - Asamblea</option>
</select>
<a href="Dashboard.html" class="btn-back">‚Üê Dashboard</a>
</div>
<div id="errorContainer"></div>
<div class="main-grid">
<div>
<div class="panel">
<h3>
<span>üìã Qu√≥rum</span>
<button class="btn-danger" onclick="limpiarAsistentes()" title="Borrar todos los asistentes"> üóëÔ∏è Limpiar </button>
<button onclick="copiarEnlaceQuorum()" 
        style="background: linear-gradient(135deg, #00B853 0%, #00875F 100%); 
               color: white; 
               border: none; 
               padding: 12px 24px; 
               border-radius: 10px; 
               font-size: 16px; 
               font-weight: 600; 
               cursor: pointer; 
               box-shadow: 0 4px 6px rgba(0,184,83,0.3);
               transition: all 0.3s;
               display: inline-flex;
               align-items: center;
               gap: 8px;"
        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,184,83,0.4)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,184,83,0.3)'"
        title="Copiar enlace para que propietarios se registren">
    üîó Enlace Auto-Registro
</button>
</h3>
<div class="qr-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e9 100%);">
    <p style="font-weight: 600; margin-bottom: 15px; color: #333; font-size: 1.1em;">üì± Enlace de Auto-Registro</p>
    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <input type="text" id="enlaceRegistroQuorum" readonly 
               style="width: 100%; padding: 12px; border: 2px solid #00B853; border-radius: 8px; font-family: monospace; font-size: 14px; text-align: center; background: #f8f9fa;"
               value="Selecciona un edificio primero">
        <button onclick="copiarEnlaceQuorum()" 
                style="width: 100%; margin-top: 10px; padding: 12px; background: linear-gradient(135deg, #00B853 0%, #00875F 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.3s;"
                onmouseover="this.style.transform='translateY(-2px)'"
                onmouseout="this.style.transform='translateY(0)'">
            üìã Copiar Enlace
        </button>
    </div>
    <p style="font-size: 0.85em; color: #666; margin-top: 12px;">
        Comparte este enlace con los propietarios por Google Chat o WhatsApp
    </p>
</div>
<div class="quorum-display">
<div class="quorum-label">QU√ìRUM ACTUAL</div>
<div class="quorum-number" id="quorumActual">0%</div>
<div class="quorum-label">
<span id="totalAsistentes">0</span> propietarios
</div>
</div>
<div class="stats-grid">
<div class="stat-box">
<div class="stat-number" id="totalCoeficiente">0</div>
<div class="stat-label">Coeficiente</div>
</div>
<div class="stat-box">
<div class="stat-number" id="totalApartamentos">0</div>
<div class="stat-label">Apartamentos</div>
</div>
<div class="stat-box">
<div class="stat-number" id="totalVotos">0</div>
<div class="stat-label">Votos</div>
</div>
</div>
<h4 style="color: #333; margin: 20px 0 10px 0;">Asistentes</h4>
<div class="asistentes-list" id="listaAsistentes">
<p style="text-align: center; color: #999; padding: 20px;">
<span class="loading-spinner"></span> Cargando...
</p>
</div>
</div>
</div>
<div>
<!-- ENLACE DE VOTACI√ìN -->
<div class="panel" style="margin-top:30px">
<h3><span style="color:#2196F3">üó≥Ô∏è Enlace de Votaci√≥n</span></h3>
<div style="background:linear-gradient(135deg,#2196F3 0%,#1976D2 100%);padding:20px;border-radius:12px">
<p style="font-weight:700;color:white;text-align:center;font-size:1.1em;margin-bottom:15px">üîó ENLACE PARA VOTAR</p>
<div style="background:white;padding:20px;border-radius:8px">
<input type="text" id="enlaceVotacionPrincipal" readonly style="width:100%;padding:15px;border:3px solid #2196F3;border-radius:8px;font-family:monospace;font-size:14px;background:#E3F2FD;margin-bottom:10px;font-weight:600;text-align:center" value="Crea una votaci√≥n primero">
<button onclick="copiarEnlaceVotacionPrincipal()" style="width:100%;padding:15px;background:linear-gradient(135deg,#2196F3 0%,#1976D2 100%);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:18px">üìã COPIAR ENLACE DE VOTACI√ìN</button>
</div>
<p style="font-size:0.9em;color:white;margin-top:15px;text-align:center;font-weight:600">‚ö†Ô∏è Comparte DURANTE la votaci√≥n</p>
</div>
</div>
<div class="panel">
<h3>
<span>üó≥Ô∏è Votaci√≥n Activa</span>
</h3>
<div id="votacionActiva">
<div class="no-votacion">
<p>üì≠ No hay votaci√≥n activa</p>
<p style="font-size: 0.9em; margin-top: 10px;">Crea una nueva votaci√≥n abajo</p>
</div>
</div>
</div>
<div class="panel" style="margin-top: 30px;">
<h3>‚ûï Crear Nueva Votaci√≥n</h3>
<div class="form-group">
<label>T√≠tulo</label>
<input type="text" id="tituloVotacion" placeholder="Ej: Aprobaci√≥n de presupuesto 2026">
</div>
<div class="form-group">
<label>Descripci√≥n</label>
<textarea id="descripcionVotacion" placeholder="Detalles de la votaci√≥n..."></textarea>
</div>
<div class="form-group">
<label>Tipo de Votaci√≥n</label>
<select id="tipoVotacion">
<option value="coeficientes">Por Coeficientes (Ponderado)</option>
<option value="nominal">Nominal Simple (1 voto = 1 apartamento)</option>
<option value="multiple">M√∫ltiple Opci√≥n</option>
</select>
</div>
<button class="btn-crear" onclick="crearVotacion()"> üó≥Ô∏è Crear Votaci√≥n </button>
</div>
</div>
</div>
</div>
<script>
// FUNCIONES GLOBALES (accesibles desde onclick)

    const input = document.getElementById('enlaceVotacionPrincipal');
    if (!input || input.value === 'Crea una votaci√≥n primero' || input.value === '') {
        alert('‚ùå Debes crear una votaci√≥n primero');
        return;
    }
    input.select();
    input.setSelectionRange(0, 99999);
    try {
        const success = document.execCommand('copy');
        if (success) {
            alert('‚úÖ Enlace de votaci√≥n copiado:\n\n' + input.value);
        } else {
            alert('‚ùå Copia manualmente:\n\n' + input.value);
        }
    } catch(err) {
        alert('‚ùå Copia manualmente:\n\n' + input.value);
    }
}
</script>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, onValue, set, push, update, remove, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
apiKey: "AIzaSyB-RIKKCnOcOctlNDKwM6Enx1Ls-wOMZSo",
authDomain: "azeche-ph.firebaseapp.com",
databaseURL: "https://azeche-ph-default-rtdb.firebaseio.com",
projectId: "azeche-ph",
storageBucket: "azeche-ph.firebasestorage.app",
messagingSenderId: "905337990521",
appId: "1:905337990521:web:c2ca4932672c59fef6c5c9"
};

// Inicializar Firebase con manejo de errores
let app, db;
try {
app = initializeApp(firebaseConfig);
db = getDatabase(app);
} catch (error) {
console.error('Error inicializando Firebase:', error);
mostrarError('Error de conexi√≥n con la base de datos. Por favor recarga la p√°gina.');
}

let edificioActual = '';
let asistentesData = {};
let votacionActual = null;
let datosEdificio = null;

// Cambio de edificio
document.getElementById('selectEdificio').addEventListener('change', async (e) => {
edificioActual = e.target.value;
if (edificioActual) {
cargarDatos();
generarQR();
} else {
limpiarVista();
}
});

async function cargarDatos() {
if (!db || !edificioActual) return;

// Cargar datos del edificio (total apartamentos y coeficientes)
try {
const edificioRef = ref(db, `edificios/${edificioActual}`);
const edificioSnapshot = await get(edificioRef);
if (edificioSnapshot.exists()) {
datosEdificio = edificioSnapshot.val();
        // document.getElementById('totalApartamentos').textContent = datosEdificio.totalApartamentos || 0;
document.getElementById('edificioNombre').textContent = datosEdificio.nombre || edificioActual;
} else {
document.getElementById('totalApartamentos').textContent = '?';
mostrarAdvertencia('No hay configuraci√≥n para este edificio');
}
} catch (error) {
console.error('Error cargando datos del edificio:', error);
mostrarError('Error cargando datos del edificio');
}

// Cargar residentes del edificio
try {
const residentesRef = ref(db, `propietarios/${edificioActual}`);
onValue(residentesRef, (snapshot) => {
const data = snapshot.val();
if (data) {
mostrarResidentes(data);
} else {
document.getElementById('totalApartamentos').textContent = '0';
mostrarAdvertencia('No hay residentes registrados');
}
}, (error) => {
console.error('Error en residentes:', error);
mostrarError('Error cargando residentes');
});
} catch (error) {
console.error('Error configurando listener residentes:', error);
}

// Cargar asistentes
try {
const asistentesRef = ref(db, `asambleas/${edificioActual}/asistentes`);
onValue(asistentesRef, (snapshot) => {
asistentesData = snapshot.val() || {};
actualizarQuorum();
mostrarAsistentes();
}, (error) => {
console.error('Error en asistentes:', error);
mostrarError('Error cargando asistentes');
});
} catch (error) {
console.error('Error configurando listener asistentes:', error);
}

// Cargar votaci√≥n activa
try {
const votacionRef = ref(db, `asambleas/${edificioActual}/votacion_activa`);
onValue(votacionRef, (snapshot) => {
votacionActual = snapshot.val();
mostrarVotacionActiva();
}, (error) => {
console.error('Error en votaci√≥n:', error);
mostrarError('Error cargando votaci√≥n');
});
} catch (error) {
console.error('Error configurando listener votaci√≥n:', error);
}
}

function mostrarResidentes(residentes) {
    // FILTRAR SOLO PROPIETARIOS (no arrendatarios)
    let totalPropietarios = 0;
    
    if (residentes) {
        Object.values(residentes).forEach(persona => {
            // Solo contar si es propietario
            if (persona.tipo === "Propietario" || persona.tipo === "propietario" || !persona.tipo) {
                totalPropietarios++;
            }
        });
    }
    
    document.getElementById("totalApartamentos").textContent = totalPropietarios;
    console.log("‚úÖ Total propietarios: " + totalPropietarios);
}

function actualizarQuorum() {
const total = Object.keys(asistentesData).length;
document.getElementById('totalAsistentes').textContent = total;

// Calcular qu√≥rum din√°micamente
let totalCoef = 0;
let coefRequerido = 0;

if (datosEdificio && datosEdificio.coeficienteQuorum) {
coefRequerido = datosEdificio.coeficienteQuorum;
} else {
coefRequerido = 0.5; // Default 50%
}

Object.values(asistentesData).forEach(a => {
totalCoef += parseFloat(a.coeficiente || 0);
});

document.getElementById('totalCoeficiente').textContent = totalCoef.toFixed(4);

// Calcular porcentaje de qu√≥rum
const quorumPorcentaje = (totalCoef / 1.0) * 100;
document.getElementById('quorumActual').textContent = Math.round(quorumPorcentaje) + '%';
}

function mostrarAsistentes() {
const lista = document.getElementById('listaAsistentes');
if (Object.keys(asistentesData).length === 0) {
lista.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Esperando registros...</p>';
return;
}
lista.innerHTML = '';
Object.entries(asistentesData).forEach(([id, asistente]) => {
const div = document.createElement('div');
div.className = 'asistente-item';
div.innerHTML = `
<div>
<div class="asistente-nombre">${asistente.nombre || 'Sin nombre'}</div>
<div class="asistente-apto">Apto ${asistente.apartamento}</div>
</div>
<div style="display: flex; align-items: center; gap: 10px;">
<div class="asistente-coef">${parseFloat(asistente.coeficiente || 0).toFixed(4)}</div>
<button class="btn-delete-asistente" onclick="eliminarAsistente('${id}')">üóëÔ∏è</button>
</div>
`;
lista.appendChild(div);
});
}

function generarQR() {
    const baseUrl = window.location.origin + window.location.pathname.replace('votacion-admin.html', '').replace('votacion-admin-corregido.html', '').replace('votacion-admin-LIMPIO.html', '');
    
    // Actualizar enlace en secci√≥n Qu√≥rum
    const urlRegistro = baseUrl + 'registro-asamblea.html?edificio=' + edificioActual;
    const inputEnlace = document.getElementById('enlaceRegistroQuorum');
    
    if (inputEnlace) {
        inputEnlace.value = urlRegistro;
        console.log('‚úÖ Enlace actualizado:', urlRegistro);
    } else {
        console.error('‚ùå No se encontr√≥ el campo enlaceRegistroQuorum');
    }
}
const bu=window.location.origin+window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")+1);const uv=bu+"asambleas.html?edificio="+edificioActual+"&votacion="+votacionId;const ip=document.getElementById("enlaceVotacionPrincipal");if(ip){ip.value=uv}
    const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
function mostrarVotacionActiva() {
const container = document.getElementById('votacionActiva');
if (!votacionActual) {
container.innerHTML = `
<div class="no-votacion">
<p>üì≠ No hay votaci√≥n activa</p>
<p style="font-size: 0.9em; margin-top: 10px;">Crea una nueva votaci√≥n abajo</p>
</div>
`;
document.getElementById('totalVotos').textContent = '0';
return;
}

const votos = votacionActual.votos || {};
const totalVotos = Object.keys(votos).length;
document.getElementById('totalVotos').textContent = totalVotos;

// Calcular resultados seg√∫n tipo de votaci√≥n
let aFavor = 0, enContra = 0, abstencion = 0;

if (tipoVotacion === 'nominal') {
  // Votaci√≥n nominal: cada apto = 1 voto
  Object.values(votos).forEach(voto => {
    if (voto.voto === 'si') aFavor++;
    else if (voto.voto === 'no') enContra++;
    else abstencion++;
  });
} else {
  // Votaci√≥n por coeficiente: ponderar por coeficiente
  Object.values(votos).forEach(voto => {
    const coef = parseFloat(voto.coeficiente || 0);
    if (voto.voto === 'si') aFavor += coef;
    else if (voto.voto === 'no') enContra += coef;
    else abstencion += coef;
  });
}

const totalParticipantes = aFavor + enContra + abstencion;
const porcAFavor = totalParticipantes > 0 ? (aFavor / totalParticipantes * 100) : 0;
const porcContra = totalParticipantes > 0 ? (enContra / totalParticipantes * 100) : 0;
const porcAbstencion = totalParticipantes > 0 ? (abstencion / totalParticipantes * 100) : 0;

container.innerHTML = `
<div class="votacion-activa">
<h4>${votacionActual.titulo}</h4>
<p style="color: #666; margin-bottom: 20px;">${votacionActual.descripcion || ''}</p>
<div class="resultado-bar">
<div class="resultado-label">
<span class="resultado-nombre">‚úÖ A Favor</span>
<span class="resultado-valor">${aFavor} votos (${porcAFavor.toFixed(1)}%)</span>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width: ${porcAFavor}%">${porcAFavor.toFixed(1)}%</div>
</div>
</div>
<div class="resultado-bar">
<div class="resultado-label">
<span class="resultado-nombre">‚ùå En Contra</span>
<span class="resultado-valor">${enContra} votos (${porcContra.toFixed(1)}%)</span>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width: ${porcContra}%; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">${porcContra.toFixed(1)}%</div>
</div>
</div>
<div class="resultado-bar">
<div class="resultado-label">
<span class="resultado-nombre">‚ö™ Abstenci√≥n</span>
<span class="resultado-valor">${abstencion} votos (${porcAbstencion.toFixed(1)}%)</span>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width: ${porcAbstencion}%; background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);">${porcAbstencion.toFixed(1)}%</div>
</div>
</div>
<div class="admin-controls">
<button class="btn-cerrar" onclick="cerrarVotacion()">üîí Cerrar Votaci√≥n</button>
<button class="btn-danger" onclick="borrarVotacion()">üóëÔ∏è Borrar Votaci√≥n</button>
<button class="btn-warning" onclick="reiniciarVotos()">üîÑ Reiniciar Votos</button>
</div>
</div>
`;
}

window.crearVotacion = async function() {
if (!edificioActual) {
alert('‚ö†Ô∏è Selecciona un edificio primero');
return;
}
const titulo = document.getElementById('tituloVotacion').value;
const descripcion = document.getElementById('descripcionVotacion').value;
const tipo = document.getElementById('tipoVotacion').value;

if (!titulo) {
alert('‚ö†Ô∏è Ingresa un t√≠tulo para la votaci√≥n');
return;
}

const votacion = {
titulo,
descripcion,
tipo,
fechaCreacion: new Date().toISOString(),
estado: 'activa',
votos: {}
};

try {
await set(ref(db, `asambleas/${edificioActual}/votacion_activa`), votacion);
document.getElementById('tituloVotacion').value = '';
document.getElementById('descripcionVotacion').value = '';
alert('‚úÖ Votaci√≥n creada exitosamente');
} catch (error) {
console.error('Error creando votaci√≥n:', error);
alert('‚ùå Error al crear votaci√≥n: ' + error.message);
}
};

window.cerrarVotacion = async function() {
if (!confirm('¬øCerrar la votaci√≥n actual? Se guardar√° en el historial.')) return;

try {
const historialRef = push(ref(db, `asambleas/${edificioActual}/historial_votaciones`));
await set(historialRef, {
...votacionActual,
fechaCierre: new Date().toISOString(),
estado: 'cerrada'
});
await set(ref(db, `asambleas/${edificioActual}/votacion_activa`), null);
alert('‚úÖ Votaci√≥n cerrada y guardada en historial');
} catch (error) {
console.error('Error cerrando votaci√≥n:', error);
alert('‚ùå Error al cerrar votaci√≥n: ' + error.message);
}
};

window.borrarVotacion = async function() {
if (!confirm('‚ö†Ô∏è ¬øBORRAR la votaci√≥n actual? Esta acci√≥n NO se puede deshacer.')) return;
if (!confirm('¬øEst√°s segura? Los votos se perder√°n para siempre.')) return;

try {
await set(ref(db, `asambleas/${edificioActual}/votacion_activa`), null);
alert('üóëÔ∏è Votaci√≥n eliminada');
} catch (error) {
console.error('Error borrando votaci√≥n:', error);
alert('‚ùå Error al borrar votaci√≥n: ' + error.message);
}
};

window.reiniciarVotos = async function() {
if (!confirm('¬øReiniciar los votos? Mantendr√° el t√≠tulo y descripci√≥n pero borrar√° todos los votos.')) return;

try {
const votacionLimpia = {
...votacionActual,
votos: {}
};
await set(ref(db, `asambleas/${edificioActual}/votacion_activa`), votacionLimpia);
alert('üîÑ Votos reiniciados');
} catch (error) {
console.error('Error reiniciando votos:', error);
alert('‚ùå Error al reiniciar votos: ' + error.message);
}
};

window.eliminarAsistente = async function(asistenteId) {
if (!confirm('¬øEliminar este asistente?')) return;

try {
await remove(ref(db, `asambleas/${edificioActual}/asistentes/${asistenteId}`));
alert('‚úÖ Asistente eliminado');
} catch (error) {
console.error('Error eliminando asistente:', error);
alert('‚ùå Error al eliminar asistente: ' + error.message);
}
};

window.limpiarAsistentes = async function() {
if (!confirm('‚ö†Ô∏è ¬øBORRAR TODOS los asistentes? Esta acci√≥n NO se puede deshacer.')) return;
if (!confirm('¬øEst√°s segura? Se perder√° todo el registro de asistencia.')) return;

try {
await set(ref(db, `asambleas/${edificioActual}/asistentes`), null);
alert('üóëÔ∏è Todos los asistentes eliminados');
} catch (error) {
console.error('Error limpiando asistentes:', error);
alert('‚ùå Error al limpiar asistentes: ' + error.message);
}
};

function mostrarError(mensaje) {
const container = document.getElementById('errorContainer');
container.innerHTML = `<div class="error-message">${mensaje}</div>`;
}

function mostrarAdvertencia(mensaje) {
const container = document.getElementById('errorContainer');
container.innerHTML = `<div class="error-message" style="background: #fff3cd; color: #856404; border-color: #ffeeba;">‚ö†Ô∏è ${mensaje}</div>`;
setTimeout(() => {
container.innerHTML = '';
}, 5000);
}

function limpiarVista() {
document.getElementById('totalApartamentos').textContent = '0';
document.getElementById('totalCoeficiente').textContent = '0';
document.getElementById('totalAsistentes').textContent = '0';
document.getElementById('quorumActual').textContent = '0%';
document.getElementById('totalVotos').textContent = '0';
document.getElementById('qrCodeContainer').innerHTML = '<div class="qr-placeholder">Selecciona edificio</div>';
document.getElementById('urlRegistro').href = '#';
document.getElementById('urlRegistro').textContent = '-';
document.getElementById('listaAsistentes').innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Esperando registros...</p>';
document.getElementById('votacionActiva').innerHTML = `
<div class="no-votacion">
<p>üì≠ No hay votaci√≥n activa</p>
<p style="font-size: 0.9em; margin-top: 10px;">Crea una nueva votaci√≥n abajo</p>
</div>
`;
}

// ========== FUNCI√ìN QR AUTO-REGISTRO ==========
// ========== FUNCI√ìN ENLACE AUTO-REGISTRO ==========
// Copiar enlace al portapapeles
// Copiar enlace desde secci√≥n Qu√≥rum
</script>


</body>


</html>