<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuentas por Pagar - Azeche P.H.</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2em;
            font-weight: 700;
        }
        
        .edificio-selector {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .edificio-selector select {
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .edificio-selector select:hover {
            background: #f0f4ff;
        }
        
        .btn-drive {
            background: #4285f4;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-drive:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }
        
        .btn-logout {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .actions-panel {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #00B853;
            color: white;
        }
        
        .btn-success:hover {
            background: #00a049;
            transform: translateY(-3px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #ffb300;
            transform: translateY(-3px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-3px);
        }
        
        .table-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            overflow: hidden;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        
        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s;
        }
        
        tbody tr:hover {
            background: #f8f9ff;
        }
        
        td {
            padding: 15px;
            font-size: 14px;
        }
        
        .estado {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
        }
        
        .estado-pendiente {
            background: #fff3cd;
            color: #856404;
        }
        
        .estado-pagada {
            background: #d4edda;
            color: #155724;
        }
        
        .estado-vencida {
            background: #f8d7da;
            color: #721c24;
        }
        
        .btn-table {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .btn-pagar {
            background: #28a745;
            color: white;
        }
        
        .btn-eliminar {
            background: #dc3545;
            color: white;
            margin-left: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .modal-header h2 {
            color: #667eea;
            font-size: 1.8em;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
        }
        
        .btn-close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Preview Excel */
        .preview-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            border: 2px solid #667eea;
            border-radius: 10px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .preview-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            position: sticky;
            top: 0;
        }
        
        .preview-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .preview-summary {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        
        .preview-summary strong {
            color: #667eea;
            font-size: 1.2em;
        }
                
        /* TABLA MEJORADA - M√ÅS COMPACTA */
        .tabla-container {
            overflow-x: auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        #tablaCuentas {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        #tablaCuentas thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        #tablaCuentas th {
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        
        #tablaCuentas td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        #tablaCuentas tbody tr:hover {
            background: #f8f9ff;
        }
        
        #tablaCuentas tbody tr:nth-child(even) {
            background: #fafbff;
        }
        
        /* Ancho de columnas espec√≠ficas */
        #tablaCuentas th:nth-child(1) { min-width: 150px; } /* Proveedor */
        #tablaCuentas th:nth-child(7) { min-width: 180px; } /* Concepto */
        #tablaCuentas th:nth-child(8) { min-width: 100px; } /* Nro Factura */
        #tablaCuentas th:nth-child(9) { min-width: 110px; } /* Valor Bruto */
        #tablaCuentas th:nth-child(10) { min-width: 80px; } /* AIU */
        #tablaCuentas th:nth-child(11) { min-width: 80px; } /* IVA */
        #tablaCuentas th:nth-child(12) { min-width: 100px; } /* Retenci√≥n */
        #tablaCuentas th:nth-child(13) { min-width: 130px; font-weight: 700; } /* Valor Neto */
        #tablaCuentas th:nth-child(22) { min-width: 120px; } /* Acciones */
        
        /* N√∫meros alineados a la derecha */
        #tablaCuentas td:nth-child(9),
        #tablaCuentas td:nth-child(10),
        #tablaCuentas td:nth-child(11),
        #tablaCuentas td:nth-child(12),
        #tablaCuentas td:nth-child(13) {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        /* Valor Neto destacado */
        
        /* COLUMNA PROVEEDOR FIJA (STICKY) */
        #tablaCuentas th:first-child,
        #tablaCuentas td:first-child {
            position: sticky;
            left: 0;
            z-index: 5;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        #tablaCuentas thead th:first-child {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 15;
        }
        
        #tablaCuentas tbody tr:nth-child(even) td:first-child {
            background: #fafbff;
        }
        
        #tablaCuentas tbody tr:hover td:first-child {
            background: #f8f9ff;
        }

        #tablaCuentas td:nth-child(13) {
            background: #f0f4ff;
            color: #667eea;
            font-weight: 700;
        }

        .tarjeta-edificio { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: transform 0.2s; min-width: 280px; flex-shrink: 0; }
        .tarjeta-edificio:hover { transform: translateY(-5px); }
        .tarjeta-edificio h3 { margin-bottom: 15px; font-size: 1.2em; }
        .tarjeta-dato { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .tarjeta-valor { font-weight: 700; font-size: 1.1em; }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üí∞ Cuentas por Pagar</h1>
            <div class="edificio-selector">
                <select id="edificioSelect" onchange="cambiarEdificio()">
                    <option value="">Selecciona edificio</option>
                    <option value="nepal-2">Nepal 2</option>
                    <option value="avalon">Avalon</option>
                    <option value="convivienda-1">Convivienda 1</option>
                    <option value="pinos-del-country">Pinos del Country</option>
                </select>
                <a href="#" id="btnDrive" class="btn-drive" target="_blank" style="display: none;">
                    üìÅ Ver Facturas Drive
                </a>

            </div>
            <button class="btn-logout" onclick="location.href='Dashboard.html'">
                üè† Dashboard
            </button>
        </div>

        <!-- PANEL DE ACCIONES -->
        <div class="actions-panel">
            <button class="btn btn-primary" onclick="document.getElementById('fileExcel').click()">
                üìä Cargar Excel de Facturas
            </button>
            <input type="file" id="fileExcel" accept=".xlsx,.xls,.csv" style="display: none;" onchange="procesarExcel(event)">
            
            <button class="btn btn-warning" onclick="abrirModalManual()">
                ‚úèÔ∏è Agregar Cuenta Manual
            </button>
            <button class="btn btn-success" onclick="descargarExcel()">
                üì• Descargar Excel
            </button>
        </div>

        <!-- RESUMEN DE FACTURAS POR EDIFICIO -->
        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìä Resumen de Facturas por Edificio</h2>
            <div id="tarjetasEdificios" style="display: flex; gap: 15px; flex-wrap: nowrap; overflow-x: auto;"></div>
        </div>

        <!-- FILTROS DE B√öSQUEDA -->
        <div class="actions-panel" style="background: white; margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; width: 100%;">
                <div style="flex: 1; min-width: 250px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #667eea;">üîç Buscar por Proveedor:</label>
                    <input type="text" id="filtroProveedor" placeholder="Escribe nombre del proveedor..." 
                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                           oninput="aplicarFiltros()">
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #667eea;">üìÖ Filtrar por Mes:</label>
                    <select id="filtroMes" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" onchange="aplicarFiltros()">
                        <option value="">Todos los meses</option>
                        <option value="01">Enero</option>
                        <option value="02">Febrero</option>
                        <option value="03">Marzo</option>
                        <option value="04">Abril</option>
                        <option value="05">Mayo</option>
                        <option value="06">Junio</option>
                        <option value="07">Julio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="limpiarFiltros()" style="align-self: flex-end;">
                    üîÑ Limpiar Filtros
                </button>
                <div style="align-self: flex-end; padding: 10px; background: #f0f4ff; border-radius: 8px; font-weight: 600;">
                    üìä Mostrando: <span id="contadorFacturas">0</span> facturas
                </div>
            </div>
        </div>

        <!-- TABLA DE CUENTAS -->
        <div class="table-container">
            <div class="table-wrapper">
                <table id="tablaCuentas">
                    <thead>
                        <tr>
                            <th>Proveedor</th>
                            <th>Tipo de ID</th>
                            <th>No. Identificaci√≥n</th>
                            <th>Banco</th>
                            <th>Tipo de Cuenta</th>
                            <th>N√∫mero de Cuenta</th>
                            <th>Concepto</th>
                            <th>Nro Factura</th>
                            <th>Valor Bruto</th>
                            <th>AIU</th>
                            <th>IVA</th>
                            <th>Retenci√≥n</th>
                            <th>Valor Neto a Pagar</th>
                            <th>üí∞ Anticipo</th>
                            <th>üìÖ Fecha Anticipo</th>
                            <th style="background: #e8f5e9; color: #00B853;">‚úÖ Saldo a Pagar</th>
                            <th>Fecha de Recepci√≥n</th>
                            <th>Fecha de Vencimiento</th>
                            <th>Fecha de Pago</th>
                            <th>Estado</th>
                            <th>M√©todo de Pago</th>
                            <th>Categor√≠a del Gasto</th>
                            <th>Prioridad</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaCuerpo">
                        <tr>
                            <td colspan="15">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üìã</div>
                                    <h3>No hay cuentas registradas para este edificio</h3>
                                    <p>Carga un Excel o agrega una cuenta manualmente</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL AGREGAR MANUAL -->
    <div class="modal" id="modalManual">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Agregar Cuenta Manual</h2>
                <button class="btn-close" onclick="cerrarModal('modalManual')">&times;</button>
            </div>
            <form id="formManual">
                <div class="form-group">
                    <label>Proveedor *</label>
                    <input type="text" id="proveedor" required list="listaProveedores">
                    <datalist id="listaProveedores">
                        <!-- Se llena din√°micamente -->
                    </datalist>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de ID *</label>
                        <select id="tipoId" required>
                            <option value="NIT">NIT</option>
                            <option value="CC">CC</option>
                            <option value="CE">CE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>No. Identificaci√≥n *</label>
                        <input type="text" id="numeroId" required>
                    </div>
                </div>
                
                <!-- DATOS BANCARIOS -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Banco</label>
                        <input type="text" id="banco" placeholder="Ej: Bancolombia">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Cuenta</label>
                        <select id="tipoCuenta">
                            <option value="">Seleccionar...</option>
                            <option value="Ahorros">Ahorros</option>
                            <option value="Corriente">Corriente</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>N√∫mero de Cuenta</label>
                    <input type="text" id="numeroCuenta">
                </div>
                
                <div class="form-group">
                    <label>Concepto *</label>
                    <input type="text" id="concepto" required>
                </div>
                <div class="form-group">
                    <label>Nro Factura</label>
                    <input type="text" id="facturaNo">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor Bruto *</label>
                        <input type="number" id="valorBruto" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>AIU</label>
                        <input type="number" id="aiu" step="0.01" value="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>IVA</label>
                        <input type="number" id="iva" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label>Retenci√≥n</label>
                        <input type="number" id="retencion" step="0.01" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Valor Neto a Pagar (calculado)</label>
                    <input type="number" id="valorNeto" step="0.01" readonly>

                <div class="form-row" style="border-top: 2px solid #667eea; padding-top: 15px; margin-top: 15px;">
                    <div class="form-group">
                        <label>üí∞ Anticipo</label>
                        <input type="number" id="anticipo" step="0.01" value="0" oninput="calcularRestoAPagar()">
                    </div>
                    <div class="form-group">
                        <label>üìÖ Fecha Anticipo</label>
                        <input type="date" id="fechaAnticipo">
                    </div>
                </div>
                <div class="form-group">
                    <label style="color: #00B853; font-weight: 700;">‚úÖ Resto a Pagar</label>
                    <input type="number" id="restoAPagar" step="0.01" readonly style="background: #e8f5e9; font-size: 1.1em; font-weight: 700; color: #00B853;">
                </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Recepci√≥n</label>
                        <input type="date" id="fechaRecepcion">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Vencimiento</label>
                        <input type="date" id="fechaVencimiento">
                    </div>
                </div>
                
                <!-- NUEVOS CAMPOS -->
                <div class="form-row">
                    <div class="form-group">
                        <label>M√©todo de Pago</label>
                        <select id="metodoPago">
                            <option value="">Seleccionar...</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Consignaci√≥n">Consignaci√≥n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select id="prioridad">
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                            <option value="Baja">Baja</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Categor√≠a del Gasto</label>
                    <select id="categoriaGasto">
                        <option value="">Seleccionar...</option>
                        <option value="Servicios P√∫blicos">Servicios P√∫blicos</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                        <option value="Conserjer√≠a y Monitoreo">Conserjer√≠a y Monitoreo</option>
                        <option value="Aseo">Aseo</option>
                        <option value="Prestaci√≥n de Servicios">Prestaci√≥n de Servicios</option>
                        <option value="Impuestos">Impuestos</option>
                        <option value="Seguros">Seguros</option>
                        <option value="Compras">Compras</option>
                        <option value="Contratos">Contratos</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="observaciones" rows="3" placeholder="Notas adicionales..."></textarea>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="guardarCuentaManual()" style="width: 100%; margin-top: 20px;">
                    üíæ Guardar Cuenta
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL EDITAR CUENTA -->
    <div class="modal" id="modalEditar">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Cuenta</h2>
                <button class="btn-close" onclick="cerrarModal('modalEditar')">&times;</button>
            </div>
            <form id="formEditar">
                <input type="hidden" id="editarId">
                <div class="form-group">
                    <label>Proveedor *</label>
                    <input type="text" id="editarProveedor" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de ID *</label>
                        <select id="editarTipoId" required>
                            <option value="NIT">NIT</option>
                            <option value="CC">CC</option>
                            <option value="CE">CE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>No. Identificaci√≥n *</label>
                        <input type="text" id="editarNumeroId" required>
                    </div>
                </div>
                
                <!-- DATOS BANCARIOS -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Banco</label>
                        <input type="text" id="editarBanco" placeholder="Ej: Bancolombia">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Cuenta</label>
                        <select id="editarTipoCuenta">
                            <option value="">Seleccionar...</option>
                            <option value="Ahorros">Ahorros</option>
                            <option value="Corriente">Corriente</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>N√∫mero de Cuenta</label>
                    <input type="text" id="editarNumeroCuenta">
                </div>
                
                <div class="form-group">
                    <label>Concepto *</label>
                    <input type="text" id="editarConcepto" required>
                </div>
                <div class="form-group">
                    <label>Nro Factura</label>
                    <input type="text" id="editarFacturaNo">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor Bruto *</label>
                        <input type="number" id="editarValorBruto" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>AIU</label>
                        <input type="number" id="editarAiu" step="0.01" value="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>IVA</label>
                        <input type="number" id="editarIva" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label>Retenci√≥n</label>
                        <input type="number" id="editarRetencion" step="0.01" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Valor Neto a Pagar (calculado)</label>
                    <input type="number" id="editarValorNeto" step="0.01" readonly>
                </div>
                
                <!-- ADELANTO EN EDICI√ìN -->
                <div class="form-row" style="border-top: 2px solid #667eea; padding-top: 15px; margin-top: 15px;">
                    <div class="form-group">
                        <label>üí∞ Anticipo</label>
                        <input type="number" id="editarAnticipo" step="0.01" value="0" oninput="calcularRestoEditar()">
                    </div>
                    <div class="form-group">
                        <label>üìÖ Fecha Anticipo</label>
                        <input type="date" id="editarFechaAnticipo">
                    </div>
                </div>
                <div class="form-group">
                    <label style="color: #00B853; font-weight: 700;">‚úÖ Resto a Pagar</label>
                    <input type="number" id="editarRestoAPagar" step="0.01" readonly style="background: #e8f5e9; font-size: 1.1em; font-weight: 700; color: #00B853;">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Recepci√≥n</label>
                        <input type="date" id="editarFechaRecepcion">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Vencimiento</label>
                        <input type="date" id="editarFechaVencimiento">
                    </div>
                </div>
                
                <!-- NUEVOS CAMPOS -->
                <div class="form-row">
                    <div class="form-group">
                        <label>M√©todo de Pago</label>
                        <select id="editarMetodoPago">
                            <option value="">Seleccionar...</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Consignaci√≥n">Consignaci√≥n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select id="editarPrioridad">
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                            <option value="Baja">Baja</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Categor√≠a del Gasto</label>
                    <select id="editarCategoriaGasto">
                        <option value="">Seleccionar...</option>
                        <option value="Servicios P√∫blicos">Servicios P√∫blicos</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                        <option value="Conserjer√≠a y Monitoreo">Conserjer√≠a y Monitoreo</option>
                        <option value="Aseo">Aseo</option>
                        <option value="Prestaci√≥n de Servicios">Prestaci√≥n de Servicios</option>
                        <option value="Impuestos">Impuestos</option>
                        <option value="Seguros">Seguros</option>
                        <option value="Compras">Compras</option>
                        <option value="Contratos">Contratos</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="editarObservaciones" rows="3" placeholder="Notas adicionales..."></textarea>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="guardarEdicion()" style="width: 100%; margin-top: 20px;">
                    üíæ Guardar Cambios
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL PREVIEW EXCEL -->
    <div class="modal" id="modalPreview">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üìä Preview - Facturas a Cargar</h2>
                <button class="btn-close" onclick="cerrarModal('modalPreview')">&times;</button>
            </div>
            <div class="preview-summary">
                Se van a cargar <strong id="totalFacturas">0</strong> facturas
            </div>
            <div class="preview-container" id="previewContainer"></div>
            <button class="btn btn-primary" onclick="confirmarCargaExcel()" style="width: 100%; margin-top: 20px;">
                ‚úÖ Confirmar y Cargar Todas
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, update, remove, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAS9c6-—ã“£_xF-p7r2eL36yaKpuwTbCg-AE",
            authDomain: "azeche-ph.firebaseapp.com",
            databaseURL: "https://azeche-ph-default-rtdb.firebaseio.com",
            projectId: "azeche-ph",
            storageBucket: "azeche-ph.firebasestorage.app",
            messagingSenderId: "357588904299",
            appId: "1:357588904299:web:7f5e83f259569477d82b1f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let edificioActual = '';
        let facturasTemp = [];
        let proveedoresDB = {}; // Base de datos de proveedores en memoria
        
        // Cargar proveedores desde Firebase al iniciar
        const proveedoresRef = ref(db, 'proveedores');
        onValue(proveedoresRef, (snapshot) => {
            proveedoresDB = {};
            const datalist = document.getElementById('listaProveedores');
            datalist.innerHTML = '';
            
            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const prov = childSnapshot.val();
                    const nombre = prov.nombre || prov.razonSocial || '';
                    
                    if (nombre) {
                        // Guardar en memoria
                        proveedoresDB[nombre.toLowerCase()] = {
                            nombre: nombre,
                            tipoId: prov.tipoIdentificacion || prov.tipoId || 'NIT',
                            numeroId: prov.noIdentificacion || prov.numeroId || prov.nit || '',
                            banco: prov.banco || '',
                            tipoCuenta: prov.tipoCuenta || '',
                            numeroCuenta: prov.numeroCuenta || prov.cuentaBancaria || '',
                            metodoPago: prov.metodoPago || ''
                        };
                        
                        // Agregar al datalist
                        const option = document.createElement('option');
                        option.value = nombre;
                        datalist.appendChild(option);
                    }
                });
                console.log(`‚úÖ ${Object.keys(proveedoresDB).length} proveedores cargados`);
            }
        });
        
        // Listener para autocompletar cuando cambie el proveedor
        document.getElementById('proveedor').addEventListener('input', function() {
            const nombreBuscado = this.value.trim().toLowerCase();
            
            if (!nombreBuscado) return;
            
            // B√∫squeda exacta primero
            let proveedor = proveedoresDB[nombreBuscado];
            
            // Si no encuentra, buscar por coincidencia parcial
            if (!proveedor) {
                for (const [key, prov] of Object.entries(proveedoresDB)) {
                    if (key.includes(nombreBuscado) || nombreBuscado.includes(key)) {
                        proveedor = prov;
                        console.log(`üîç Coincidencia parcial: "${nombreBuscado}" ‚Üí "${prov.nombre}"`);
                        break;
                    }
                }
            }
            
            if (proveedor) {
                // Auto-llenar todos los campos
                document.getElementById('tipoId').value = proveedor.tipoId || 'NIT';
                document.getElementById('numeroId').value = proveedor.numeroId || '';
                document.getElementById('banco').value = proveedor.banco || '';
                document.getElementById('tipoCuenta').value = proveedor.tipoCuenta || '';
                document.getElementById('numeroCuenta').value = proveedor.numeroCuenta || '';
                if (proveedor.metodoPago) {
                    document.getElementById('metodoPago').value = proveedor.metodoPago;
                }
                
                console.log('‚úÖ Datos autocompletados:', {
                    nombre: proveedor.nombre,
                    banco: proveedor.banco || '(vac√≠o)',
                    tipoCuenta: proveedor.tipoCuenta || '(vac√≠o)',
                    numeroCuenta: proveedor.numeroCuenta || '(vac√≠o)'
                });
            } else {
                console.log(`‚ö†Ô∏è Proveedor "${nombreBuscado}" no encontrado en la base de datos`);
            }
        });
        
        // Links de Google Drive
        const driveLinks = {
            'nepal-2': 'https://drive.google.com/drive/folders/11zgqRM4LhNRW5luW0B6pA06e42Xzu4Hc',
            'avalon': 'https://drive.google.com/drive/folders/1x_vnC5l8Q50KxdQfsvIHx1wy8s8Gjrlk',
            'convivienda-1': 'https://drive.google.com/drive/folders/1mEeVfXj74AoSkeCb2uSB00QIblwSdD1W',
            'pinos-del-country': 'https://drive.google.com/drive/folders/1QYPuq6w1fHNSl5aq1fD2R7hDJjScJAtu'
        };
        
        window.cambiarEdificio = function() {
            edificioActual = document.getElementById('edificioSelect').value;
            
            // Mostrar/ocultar bot√≥n Drive
            const btnDrive = document.getElementById('btnDrive');
            if (edificioActual && driveLinks[edificioActual]) {
                btnDrive.href = driveLinks[edificioActual];
                btnDrive.style.display = 'inline-flex';
            } else {
                btnDrive.style.display = 'none';
            }
            
            cargarCuentas();
        };
        
        function cargarCuentas() {
            if (!edificioActual) {
                document.getElementById('tablaCuerpo').innerHTML = `
                    <tr><td colspan="22">
                        <div class="empty-state">
                            <div class="empty-state-icon">üè¢</div>
                            <h3>Selecciona un edificio</h3>
                        </div>
                    </td></tr>
                `;
                document.getElementById('contadorFacturas').textContent = '0';
                return;
            }
            
            const cuentasRef = ref(db, `cuentas_por_pagar/${edificioActual}`);
            onValue(cuentasRef, (snapshot) => {
                console.log('üìä Cargando cuentas de Firebase...');
                const tbody = document.getElementById('tablaCuerpo');
                tbody.innerHTML = '';
                
                if (!snapshot.exists()) {
                    console.log('‚ö†Ô∏è No hay datos en Firebase');
                    tbody.innerHTML = `
                        <tr><td colspan="22">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <h3>No hay cuentas registradas para este edificio</h3>
                                <p>Carga un Excel o agrega una cuenta manualmente</p>
                            </div>
                        </td></tr>
                    `;
                    document.getElementById('contadorFacturas').textContent = '0';
                    return;
                }
                
                let contador = 0;
                snapshot.forEach((childSnapshot) => {
                    const cuenta = childSnapshot.val();
                    const id = childSnapshot.key;
                    console.log('‚úÖ Cargando cuenta:', cuenta.proveedor);
                    tbody.innerHTML += crearFilaCuenta(cuenta, id);
                    contador++;
                });
                
                console.log(`‚úÖ Total cuentas cargadas: ${contador}`);
                
                // Actualizar contador
                document.getElementById('contadorFacturas').textContent = contador;
                
                // MIGRACI√ìN AUTOM√ÅTICA: Actualizar datos bancarios vac√≠os
                migrarDatosBancarios(snapshot);
                
                // Aplicar filtros si hay alguno activo
                if (document.getElementById('filtroProveedor').value || document.getElementById('filtroMes').value) {
                    aplicarFiltros();
                }
            });
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MIGRACI√ìN AUTOM√ÅTICA DE DATOS BANCARIOS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function migrarDatosBancarios(snapshot) {
            let actualizados = 0;
            let sinCambios = 0;
            
            console.log('üîÑ Iniciando migraci√≥n autom√°tica de datos bancarios...');
            
            for (const childSnapshot of snapshot.val() ? Object.entries(snapshot.val()) : []) {
                const [id, cuenta] = childSnapshot;
                
                // Verificar si faltan datos bancarios
                const faltaBanco = !cuenta.banco || cuenta.banco === '-';
                const faltaTipoCuenta = !cuenta.tipoCuenta || cuenta.tipoCuenta === '-';
                const faltaNumeroCuenta = !cuenta.numeroCuenta || cuenta.numeroCuenta === '-';
                
                if (faltaBanco || faltaTipoCuenta || faltaNumeroCuenta) {
                    // Buscar proveedor en base de datos
                    const nombreProveedor = (cuenta.proveedor || '').toLowerCase();
                    const proveedor = proveedoresDB[nombreProveedor];
                    
                    if (proveedor) {
                        // Preparar datos a actualizar
                        const datosActualizar = {};
                        
                        if (faltaBanco && proveedor.banco) {
                            datosActualizar.banco = proveedor.banco;
                        }
                        if (faltaTipoCuenta && proveedor.tipoCuenta) {
                            datosActualizar.tipoCuenta = proveedor.tipoCuenta;
                        }
                        if (faltaNumeroCuenta && proveedor.numeroCuenta) {
                            datosActualizar.numeroCuenta = proveedor.numeroCuenta;
                        }
                        
                        // Si hay datos para actualizar
                        if (Object.keys(datosActualizar).length > 0) {
                            try {
                                const cuentaRef = ref(db, `cuentas_por_pagar/${edificioActual}/${id}`);
                                await update(cuentaRef, datosActualizar);
                                actualizados++;
                                console.log(`‚úÖ Actualizado: ${cuenta.proveedor} (Factura: ${cuenta.facturaNo})`);
                            } catch (error) {
                                console.error(`‚ùå Error actualizando ${cuenta.proveedor}:`, error);
                            }
                        }
                    } else {
                        sinCambios++;
                    }
                } else {
                    sinCambios++;
                }
            }
            
            if (actualizados > 0) {
                console.log(`‚úÖ Migraci√≥n completada: ${actualizados} cuentas actualizadas, ${sinCambios} sin cambios`);
            } else {
                console.log(`‚ÑπÔ∏è No hay cuentas para actualizar (${sinCambios} ya tienen datos completos)`);
            }
        }
        
        function crearFilaCuenta(cuenta, id) {
            const estadoClass = cuenta.estado === 'Pagada' ? 'estado-pagada' : 
                               (new Date(cuenta.fechaVencimiento) < new Date() ? 'estado-vencida' : 'estado-pendiente');
            
            return `
                <tr data-proveedor="${(cuenta.proveedor || '').toLowerCase()}" data-fecha="${cuenta.fechaVencimiento || ''}">
                    <td>${cuenta.proveedor || ''}</td>
                    <td>${cuenta.tipoId || ''}</td>
                    <td>${cuenta.numeroId || ''}</td>
                    <td>${cuenta.banco || '-'}</td>
                    <td>${cuenta.tipoCuenta || '-'}</td>
                    <td>${cuenta.numeroCuenta || '-'}</td>
                    <td>${cuenta.concepto || ''}</td>
                    <td>${cuenta.facturaNo || ''}</td>
                    <td>$${Number(cuenta.valorBruto || 0).toLocaleString('es-CO')}</td>
                    <td>$${Number(cuenta.aiu || 0).toLocaleString('es-CO')}</td>
                    <td>$${Number(cuenta.iva || 0).toLocaleString('es-CO')}</td>
                    <td>$${Number(cuenta.retencion || 0).toLocaleString('es-CO')}</td>
                    <td><strong>$${Number(cuenta.valorNeto || 0).toLocaleString('es-CO')}</strong></td>
                    <td style="color: #ff9800;">${cuenta.anticipo ? '$' + Number(cuenta.anticipo).toLocaleString('es-CO') : '-'}</td>
                    <td>${cuenta.fechaAnticipo || '-'}</td>
                    <td style="background: #e8f5e9; font-weight: 700; color: #00B853;"><strong>$${Number((cuenta.valorNeto || 0) - (cuenta.anticipo || 0)).toLocaleString('es-CO')}</strong></td>
                    <td>${cuenta.fechaRecepcion || '-'}</td>
                    <td>${cuenta.fechaVencimiento || '-'}</td>
                    <td>${cuenta.fechaPago || '-'}</td>
                    <td><span class="estado ${estadoClass}">${cuenta.estado || 'Pendiente'}</span></td>
                    <td>${cuenta.metodoPago || '-'}</td>
                    <td>${cuenta.categoriaGasto || '-'}</td>
                    <td>${cuenta.prioridad || 'Media'}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${cuenta.observaciones || ''}">${cuenta.observaciones || '-'}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn-table" style="background: #4a90e2; color: white;" onclick="abrirEditar('${id}')">‚úèÔ∏è</button>
                        ${cuenta.estado !== 'Pagada' ? 
                            `<button class="btn-table btn-pagar" onclick="marcarPagada('${id}')">‚úÖ</button>` : ''}
                        <button class="btn-table btn-eliminar" onclick="eliminarCuenta('${id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }
        
        // PROCESAR EXCEL
        window.procesarExcel = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!edificioActual) {
                alert('‚ùå Selecciona un edificio primero');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        alert('‚ùå El Excel est√° vac√≠o');
                        return;
                    }
                    
                    // Convertir a formato del sistema
                    facturasTemp = jsonData.map(row => ({
                        proveedor: row['Proveedor'] || row['proveedor'] || '',
                        tipoId: row['Tipo ID'] || row['tipoId'] || row['TipoID'] || 'NIT',
                        numeroId: String(row['No. Identificaci√≥n'] || row['numeroId'] || row['NIT'] || ''),
                        concepto: row['Concepto'] || row['concepto'] || '',
                        facturaNo: String(row['Factura No.'] || row['facturaNo'] || row['Factura'] || ''),
                        valorBruto: Number(row['Valor Bruto'] || row['valorBruto'] || 0),
                        aiu: Number(row['AIU'] || row['aiu'] || 0),
                        iva: Number(row['IVA'] || row['iva'] || 0),
                        retencion: Number(row['Retenci√≥n'] || row['retencion'] || row['Retencion'] || 0),
                        valorNeto: Number(row['Valor Neto'] || row['valorNeto'] || 0),
                        fechaRecepcion: formatearFecha(row['F. Recepci√≥n'] || row['fechaRecepcion'] || row['Fecha Recepci√≥n']),
                        fechaVencimiento: formatearFecha(row['F. Vencimiento'] || row['fechaVencimiento'] || row['Fecha Vencimiento']),
                        fechaPago: row['F. Pago'] || row['fechaPago'] ? formatearFecha(row['F. Pago'] || row['fechaPago']) : null,
                        estado: row['Estado'] || row['estado'] || 'Pendiente'
                    }));
                    
                    // Calcular valor neto si no viene
                    facturasTemp = facturasTemp.map(f => ({
                        ...f,
                        valorNeto: f.valorNeto || (f.valorBruto + f.aiu + f.iva - f.retencion)
                    }));
                    
                    mostrarPreview();
                    
                } catch (error) {
                    console.error(error);
                    alert('‚ùå Error al leer el Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };
        
        function formatearFecha(fecha) {
            if (!fecha) return new Date().toISOString().split('T')[0];
            if (typeof fecha === 'number') {
                // Excel date
                const date = new Date((fecha - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            if (typeof fecha === 'string') {
                const date = new Date(fecha);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            }
            return new Date().toISOString().split('T')[0];
        }
        
        function mostrarPreview() {
            document.getElementById('totalFacturas').textContent = facturasTemp.length;
            
            let html = '<table class="preview-table"><thead><tr>';
            html += '<th>Proveedor</th><th>Concepto</th><th>Factura</th><th>Valor Neto</th><th>F. Venc.</th>';
            html += '</tr></thead><tbody>';
            
            facturasTemp.forEach(f => {
                html += `<tr>
                    <td>${f.proveedor}</td>
                    <td>${f.concepto}</td>
                    <td>${f.facturaNo}</td>
                    <td>$${f.valorNeto.toLocaleString('es-CO')}</td>
                    <td>${f.fechaVencimiento}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('previewContainer').innerHTML = html;
            document.getElementById('modalPreview').classList.add('active');
        }
        
        window.confirmarCargaExcel = async function() {
            if (!edificioActual) {
                alert('‚ùå Selecciona un edificio');
                return;
            }
            
            try {
                const cuentasRef = ref(db, `cuentas_por_pagar/${edificioActual}`);
                
                for (const factura of facturasTemp) {
                    await push(cuentasRef, {
                        ...factura,
                        fechaCreacion: new Date().toISOString(),
                        creadoPor: 'Carga Excel'
                    });
                }
                
                alert(`‚úÖ ${facturasTemp.length} facturas cargadas exitosamente`);
                cerrarModal('modalPreview');
                facturasTemp = [];
                document.getElementById('fileExcel').value = '';
                
            } catch (error) {
                console.error(error);
                alert('‚ùå Error al cargar facturas: ' + error.message);
            }
        };
        
        // MODAL MANUAL
        window.abrirModalManual = function() {
            if (!edificioActual) {
                alert('‚ùå Selecciona un edificio primero');
                return;
            }
            document.getElementById('modalManual').classList.add('active');
            document.getElementById('fechaRecepcion').valueAsDate = new Date();
        };
        
        ['valorBruto', 'aiu', 'iva', 'retencion'].forEach(id => {
            document.getElementById(id).addEventListener('input', calcularValorNeto);
        });
        
        function calcularValorNeto() {
            const bruto = parseFloat(document.getElementById('valorBruto').value) || 0;
            const aiu = parseFloat(document.getElementById('aiu').value) || 0;
            const iva = parseFloat(document.getElementById('iva').value) || 0;
            const ret = parseFloat(document.getElementById('retencion').value) || 0;
            
            const neto = bruto + aiu + iva - ret;
            document.getElementById('valorNeto').value = neto.toFixed(2);
        }

        // Calcular Resto a Pagar en formulario agregar
        function calcularRestoAPagar() {
            const valorNeto = parseFloat(document.getElementById('valorNeto').value) || 0;
            const anticipo = parseFloat(document.getElementById('anticipo').value) || 0;
            const resto = valorNeto - anticipo;
            document.getElementById('restoAPagar').value = resto.toFixed(2);
        }
        
        // Calcular Resto a Pagar en formulario editar
        function calcularRestoEditar() {
            const valorNeto = parseFloat(document.getElementById('editarValorNeto').value) || 0;
            const anticipo = parseFloat(document.getElementById('editarAnticipo').value) || 0;
            const resto = valorNeto - anticipo;
            document.getElementById('editarRestoAPagar').value = resto.toFixed(2);
        }
        
        // Recalcular tambi√©n cuando cambia el valor neto
        function calcularValorNetoEditar() {
            const bruto = parseFloat(document.getElementById('editarValorBruto').value) || 0;
            const aiu = parseFloat(document.getElementById('editarAiu').value) || 0;
            const iva = parseFloat(document.getElementById('editarIva').value) || 0;
            const ret = parseFloat(document.getElementById('editarRetencion').value) || 0;
            const neto = bruto + aiu + iva - ret;
            document.getElementById('editarValorNeto').value = neto.toFixed(2);
            calcularRestoEditar(); // Recalcular resto
        }
        
        window.guardarCuentaManual = async function() {
            // Validar solo campos ESENCIALES
            const proveedor = document.getElementById('proveedor').value.trim();
            const numeroId = document.getElementById('numeroId').value.trim();
            const concepto = document.getElementById('concepto').value.trim();
            const valorBruto = document.getElementById('valorBruto').value;
            
            if (!proveedor || !numeroId || !concepto || !valorBruto) {
                alert('‚ùå Completa los campos obligatorios:\n‚Ä¢ Proveedor\n‚Ä¢ No. Identificaci√≥n\n‚Ä¢ Concepto\n‚Ä¢ Valor Bruto');
                return;
            }
            
            const nuevaCuenta = {
                proveedor: proveedor,
                tipoId: document.getElementById('tipoId').value,
                numeroId: numeroId,
                banco: document.getElementById('banco').value || '',
                tipoCuenta: document.getElementById('tipoCuenta').value || '',
                numeroCuenta: document.getElementById('numeroCuenta').value || '',
                concepto: concepto,
                facturaNo: document.getElementById('facturaNo').value || 'N/A',
                valorBruto: parseFloat(valorBruto),
                aiu: parseFloat(document.getElementById('aiu').value) || 0,
                iva: parseFloat(document.getElementById('iva').value) || 0,
                retencion: parseFloat(document.getElementById('retencion').value) || 0,
                valorNeto: parseFloat(document.getElementById('valorNeto').value) || parseFloat(valorBruto),
                anticipo: parseFloat(document.getElementById('anticipo').value) || 0,
                fechaAnticipo: document.getElementById('fechaAnticipo').value || null,
                restoAPagar: parseFloat(document.getElementById('restoAPagar').value) || parseFloat(document.getElementById('valorNeto').value),
                fechaRecepcion: document.getElementById('fechaRecepcion').value || null,
                fechaVencimiento: document.getElementById('fechaVencimiento').value || null,
                fechaPago: null,
                estado: 'Pendiente',
                metodoPago: document.getElementById('metodoPago').value || '',
                categoriaGasto: document.getElementById('categoriaGasto').value || '',
                prioridad: document.getElementById('prioridad').value || 'Media',
                observaciones: document.getElementById('observaciones').value || '',
                creadoPor: 'Manual',
                fechaCreacion: new Date().toISOString()
            };
            
            try {
                const cuentasRef = ref(db, `cuentas_por_pagar/${edificioActual}`);
                await push(cuentasRef, nuevaCuenta);
                
                alert('‚úÖ Cuenta agregada exitosamente\n\nPuedes agregar los datos faltantes edit√°ndola despu√©s.');
                cerrarModal('modalManual');
                document.getElementById('formManual').reset();
            } catch (error) {
                alert('‚ùå Error al guardar: ' + error.message);
                console.error('Error:', error);
            }
        };
        
        window.marcarPagada = async function(id) {
            if (!confirm('¬øMarcar como pagada?')) return;
            
            const cuentaRef = ref(db, `cuentas_por_pagar/${edificioActual}/${id}`);
            await update(cuentaRef, {
                estado: 'Pagada',
                fechaPago: new Date().toISOString().split('T')[0]
            });
            
            alert('‚úÖ Cuenta marcada como pagada');
        };
        
        window.eliminarCuenta = async function(id) {
            if (!confirm('¬øEliminar esta cuenta? No se puede deshacer.')) return;
            
            const cuentaRef = ref(db, `cuentas_por_pagar/${edificioActual}/${id}`);
            await remove(cuentaRef);
            
            alert('‚úÖ Cuenta eliminada');
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FUNCIONES DE EDICI√ìN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.abrirEditar = async function(id) {
            try {
                // Leer cuenta de Firebase
                const cuentaRef = ref(db, `cuentas_por_pagar/${edificioActual}/${id}`);
                const snapshot = await new Promise((resolve) => {
                    onValue(cuentaRef, resolve, { onlyOnce: true });
                });
                
                if (!snapshot.exists()) {
                    alert('‚ùå Cuenta no encontrada');
                    return;
                }
                
                const cuenta = snapshot.val();
                
                // Llenar formulario de edici√≥n
                document.getElementById('editarId').value = id;
                document.getElementById('editarProveedor').value = cuenta.proveedor || '';
                document.getElementById('editarTipoId').value = cuenta.tipoId || 'NIT';
                document.getElementById('editarNumeroId').value = cuenta.numeroId || '';
                document.getElementById('editarBanco').value = cuenta.banco || '';
                document.getElementById('editarTipoCuenta').value = cuenta.tipoCuenta || '';
                document.getElementById('editarNumeroCuenta').value = cuenta.numeroCuenta || '';
                document.getElementById('editarConcepto').value = cuenta.concepto || '';
                document.getElementById('editarFacturaNo').value = cuenta.facturaNo || '';
                document.getElementById('editarValorBruto').value = cuenta.valorBruto || 0;
                document.getElementById('editarAiu').value = cuenta.aiu || 0;
                document.getElementById('editarIva').value = cuenta.iva || 0;
                document.getElementById('editarRetencion').value = cuenta.retencion || 0;
                document.getElementById('editarValorNeto').value = cuenta.valorNeto || 0;
                document.getElementById('editarFechaRecepcion').value = cuenta.fechaRecepcion || '';
                document.getElementById('editarFechaVencimiento').value = cuenta.fechaVencimiento || '';
                document.getElementById('editarMetodoPago').value = cuenta.metodoPago || '';
                document.getElementById('editarPrioridad').value = cuenta.prioridad || 'Media';
                document.getElementById('editarCategoriaGasto').value = cuenta.categoriaGasto || '';
                document.getElementById('editarObservaciones').value = cuenta.observaciones || '';
                document.getElementById('editarAnticipo').value = cuenta.anticipo || 0;
                document.getElementById('editarFechaAnticipo').value = cuenta.fechaAnticipo || '';
                document.getElementById('editarRestoAPagar').value = cuenta.restoAPagar || cuenta.valorNeto || 0;
                
                // Abrir modal
                document.getElementById('modalEditar').classList.add('active');
                
            } catch (error) {
                alert('‚ùå Error al cargar cuenta: ' + error.message);
                console.error('Error:', error);
            }
        };
        
        // Calcular valor neto en edici√≥n
        ['editarValorBruto', 'editarAiu', 'editarIva', 'editarRetencion'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                const bruto = parseFloat(document.getElementById('editarValorBruto').value) || 0;
                const aiu = parseFloat(document.getElementById('editarAiu').value) || 0;
                const iva = parseFloat(document.getElementById('editarIva').value) || 0;
                const ret = parseFloat(document.getElementById('editarRetencion').value) || 0;
                
                const neto = bruto + aiu + iva - ret;
                document.getElementById('editarValorNeto').value = neto.toFixed(2);
            });
        });
        
        window.guardarEdicion = async function() {
            const id = document.getElementById('editarId').value;
            
            // Validar campos esenciales
            const proveedor = document.getElementById('editarProveedor').value.trim();
            const numeroId = document.getElementById('editarNumeroId').value.trim();
            const concepto = document.getElementById('editarConcepto').value.trim();
            const valorBruto = document.getElementById('editarValorBruto').value;
            
            if (!proveedor || !numeroId || !concepto || !valorBruto) {
                alert('‚ùå Completa los campos obligatorios:\n‚Ä¢ Proveedor\n‚Ä¢ No. Identificaci√≥n\n‚Ä¢ Concepto\n‚Ä¢ Valor Bruto');
                return;
            }
            
            try {
                const datosActualizados = {
                    proveedor: proveedor,
                    tipoId: document.getElementById('editarTipoId').value,
                    numeroId: numeroId,
                    banco: document.getElementById('editarBanco').value || '',
                    tipoCuenta: document.getElementById('editarTipoCuenta').value || '',
                    numeroCuenta: document.getElementById('editarNumeroCuenta').value || '',
                    concepto: concepto,
                    facturaNo: document.getElementById('editarFacturaNo').value || '',
                    valorBruto: parseFloat(valorBruto),
                    aiu: parseFloat(document.getElementById('editarAiu').value) || 0,
                    iva: parseFloat(document.getElementById('editarIva').value) || 0,
                    retencion: parseFloat(document.getElementById('editarRetencion').value) || 0,
                    valorNeto: parseFloat(document.getElementById('editarValorNeto').value) || parseFloat(valorBruto),
                    anticipo: parseFloat(document.getElementById('editarAnticipo').value) || 0,
                    fechaAnticipo: document.getElementById('editarFechaAnticipo').value || null,
                    restoAPagar: parseFloat(document.getElementById('editarRestoAPagar').value) || parseFloat(document.getElementById('editarValorNeto').value),
                    fechaRecepcion: document.getElementById('editarFechaRecepcion').value || null,
                    fechaVencimiento: document.getElementById('editarFechaVencimiento').value || null,
                    metodoPago: document.getElementById('editarMetodoPago').value || '',
                    categoriaGasto: document.getElementById('editarCategoriaGasto').value || '',
                    prioridad: document.getElementById('editarPrioridad').value || 'Media',
                    observaciones: document.getElementById('editarObservaciones').value || ''
                };
                
                const cuentaRef = ref(db, `cuentas_por_pagar/${edificioActual}/${id}`);
                await update(cuentaRef, datosActualizados);
                
                alert('‚úÖ Cuenta actualizada exitosamente');
                cerrarModal('modalEditar');
                
            } catch (error) {
                alert('‚ùå Error al guardar: ' + error.message);
                console.error('Error:', error);
            }
        };
        
        window.descargarExcel = async function() {
            if (!edificioActual) {
                alert('‚ùå Selecciona un edificio primero');
                return;
            }
            
            try {
                // Leer cuentas de Firebase
                const cuentasRef = ref(db, `cuentas_por_pagar/${edificioActual}`);
                const snapshot = await new Promise((resolve) => {
                    onValue(cuentasRef, resolve, { onlyOnce: true });
                });
                
                if (!snapshot.exists()) {
                    alert('‚ùå No hay cuentas registradas para este edificio');
                    return;
                }
                
                // Convertir a array
                const cuentas = [];
                snapshot.forEach((childSnapshot) => {
                    cuentas.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // Crear datos para Excel
                const datosExcel = cuentas.map(c => ({
                    'Proveedor': c.proveedor || '',
                    'Tipo de ID': c.tipoId || 'NIT',
                    'No. Identificaci√≥n': c.numeroId || '',
                    'Banco': c.banco || '',
                    'Tipo de Cuenta': c.tipoCuenta || '',
                    'N√∫mero de Cuenta': c.numeroCuenta || '',
                    'Concepto': c.concepto || '',
                    'Nro Factura': c.facturaNo || '',
                    'Valor Bruto': c.valorBruto || 0,
                    'AIU': c.aiu || 0,
                    'IVA': c.iva || 0,
                    'Retenci√≥n': c.retencion || 0,
                    'Valor Neto a Pagar': c.valorNeto || 0,
                    'Fecha de Recepci√≥n': c.fechaRecepcion || '',
                    'Fecha de Vencimiento': c.fechaVencimiento || '',
                    'Fecha de Pago': c.fechaPago || '',
                    'Estado': c.estado || 'Pendiente',
                    'M√©todo de Pago': c.metodoPago || '',
                    'Categor√≠a del Gasto': c.categoriaGasto || '',
                    'Prioridad': c.prioridad || 'Media',
                    'Observaciones': c.observaciones || ''
                }));
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(datosExcel);
                
                // Ajustar anchos de columnas
                ws['!cols'] = [
                    { wch: 30 }, // Proveedor
                    { wch: 12 }, // Tipo de ID
                    { wch: 18 }, // No. ID
                    { wch: 20 }, // Banco
                    { wch: 15 }, // Tipo de Cuenta
                    { wch: 20 }, // N√∫mero de Cuenta
                    { wch: 35 }, // Concepto
                    { wch: 15 }, // Nro Factura / CAE
                    { wch: 14 }, // Valor Bruto
                    { wch: 12 }, // AIU
                    { wch: 12 }, // IVA
                    { wch: 16 }, // Retenci√≥n
                    { wch: 18 }, // Valor Neto a Pagar
                    { wch: 18 }, // Fecha Recepci√≥n
                    { wch: 20 }, // Fecha Vencimiento
                    { wch: 15 }, // Fecha Pago
                    { wch: 12 }, // Estado
                    { wch: 18 }, // M√©todo de Pago
                    { wch: 25 }, // Categor√≠a del Gasto
                    { wch: 12 }, // Prioridad
                    { wch: 40 }  // Observaciones
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Cuentas por Pagar');
                
                // Descargar
                const nombreArchivo = `Cuentas_Por_Pagar_${edificioActual}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, nombreArchivo);
                
                alert(`‚úÖ Excel descargado exitosamente!\n\nüìä ${cuentas.length} cuentas exportadas\nüìÅ Archivo: ${nombreArchivo}`);
                
            } catch (error) {
                console.error('Error descargando Excel:', error);
                alert('‚ùå Error al descargar Excel: ' + error.message);
            }
        };
        
        window.cerrarModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FUNCIONES DE FILTROS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.aplicarFiltros = function() {
            const filtroProveedor = document.getElementById('filtroProveedor').value.toLowerCase();
            const filtroMes = document.getElementById('filtroMes').value;
            
            const filas = document.querySelectorAll('#tablaCuerpo tr');
            let contador = 0;
            
            filas.forEach(fila => {
                // Obtener datos de la fila
                const proveedor = fila.getAttribute('data-proveedor') || '';
                const fecha = fila.getAttribute('data-fecha') || '';
                const mesFecha = fecha ? fecha.substring(5, 7) : ''; // Extrae mes de YYYY-MM-DD
                
                // Aplicar filtros
                const coincideProveedor = !filtroProveedor || proveedor.includes(filtroProveedor);
                const coincideMes = !filtroMes || mesFecha === filtroMes;
                
                if (coincideProveedor && coincideMes) {
                    fila.style.display = '';
                    contador++;
                } else {
                    fila.style.display = 'none';
                }
            });
            
            // Actualizar contador
            document.getElementById('contadorFacturas').textContent = contador;
        };
        
        window.limpiarFiltros = function() {
            document.getElementById('filtroProveedor').value = '';
            document.getElementById('filtroMes').value = '';
            aplicarFiltros();
        };

        // CARGAR RESUMEN
        async function cargarResumen() {
            const container = document.getElementById('tarjetasEdificios');
            if (!container) return;
            
            const edificios = [
                { id: 'nepal-2', nombre: 'Nepal 2', icono: 'üè¢' },
                { id: 'avalon', nombre: 'Avalon', icono: 'üè∞' },
                { id: 'convivienda-1', nombre: 'Convivienda I', icono: 'üèòÔ∏è' },
                { id: 'pinos-del-country', nombre: 'Pinos del Country', icono: 'üå≤' }
            ];
            
            let html = '';
            for (const ed of edificios) {
                const snap = await get(ref(db, `cuentas_por_pagar/${ed.id}`));
                let total = 0, pend = 0, pag = 0, deuda = 0;
                if (snap.exists()) {
                    snap.forEach((c) => {
                        const ct = c.val();
                        total++;
                        if (ct.estado === 'Pagada' || ct.estado === 'pagada') pag++; else { pend++; deuda += parseFloat(ct.valorNeto || 0); }
                    });
                }
                html += `<div class="tarjeta-edificio"><h3>${ed.icono} ${ed.nombre}</h3><div class="tarjeta-dato"><span>Total:</span><span class="tarjeta-valor">${total}</span></div><div class="tarjeta-dato" style="background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;margin:8px 0"><span>‚ö†Ô∏è Pendientes:</span><span class="tarjeta-valor" style="font-size:1.5em">${pend}</span></div><div class="tarjeta-dato"><span>‚úÖ Pagadas:</span><span class="tarjeta-valor">${pag}</span></div><div class="tarjeta-dato" style="border-top:2px solid rgba(255,255,255,0.3);margin-top:8px;padding-top:8px"><span>Deuda:</span><span class="tarjeta-valor">$${deuda.toLocaleString('es-CO')}</span></div></div>`;
            }
            container.innerHTML = html;
        }
        
        setTimeout(cargarResumen, 1000);
    </script>
</body>
</html>
