<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Votacion - Azeche P.H.</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #6B2FA0 0%, #9C27B0 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 600px; margin: 0 auto; }
.header { background: white; padding: 30px; border-radius: 20px 20px 0 0; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
.logo-text { font-size: 2.5em; font-weight: 900; }
.logo-blue { color: #0056B8; }
.logo-purple { color: #6B2FA0; }
.edificio-nombre { color: #666; font-size: 1.1em; margin-top: 10px; }
.content { background: white; padding: 30px; border-radius: 0 0 20px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.step { display: none; }
.step.active { display: block; }
.step h2 { color: #6B2FA0; margin-bottom: 20px; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; }
.form-group select { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; }
.form-group select:focus { outline: none; border-color: #6B2FA0; }
.btn { width: 100%; padding: 18px; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; margin-top: 10px; background: linear-gradient(135deg, #6B2FA0 0%, #9C27B0 100%); color: white; }
.btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
.btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
.votacion-card { background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid #6B2FA0; }
.votacion-card h3 { color: #333; margin-bottom: 10px; }
.votacion-card p { color: #666; line-height: 1.6; }
.tipo-info { display: inline-block; background: #6B2FA0; color: white; padding: 3px 10px; border-radius: 10px; font-size: 0.8em; margin-top: 8px; }
.opciones-voto { display: grid; gap: 15px; margin: 20px 0; }
.opcion-voto { background: white; border: 3px solid #ddd; padding: 20px; border-radius: 15px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 15px; font-size: 1.1em; font-weight: 600; }
.opcion-voto:hover { border-color: #6B2FA0; transform: translateY(-3px); }
.opcion-voto.selected { border-color: #9C27B0; background: rgba(156, 39, 176, 0.1); }
.opcion-numero { width: 40px; height: 40px; border-radius: 50%; background: #e9ecef; display: flex; align-items: center; justify-content: center; font-weight: 900; color: #6B2FA0; }
.opcion-voto.selected .opcion-numero { background: #9C27B0; color: white; }
.success-message { text-align: center; padding: 40px; }
.success-icon { font-size: 5em; margin-bottom: 20px; }
.success-message h2 { color: #9C27B0; margin-bottom: 15px; }
.resultados { margin-top: 30px; }
.resultado-bar { margin-bottom: 20px; }
.resultado-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; color: #333; }
.progress-bar { height: 40px; background: #e9ecef; border-radius: 20px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(135deg, #9C27B0 0%, #6B2FA0 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; transition: width 0.5s ease; }
.info-badge { background: #e1bee7; border-left: 4px solid #6B2FA0; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
.info-badge p { color: #4a148c; margin: 0; }
.waiting-msg { text-align: center; padding: 30px; color: #666; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo-text"><span class="logo-blue">AZECHE</span> <span class="logo-purple">PH</span></div>
    <div class="edificio-nombre" id="edificioNombre">CARGANDO...</div>
  </div>
  <div class="content">
    <div id="errorMsg"></div>
    
    <!-- STEP 1: Registro -->
    <div class="step active" id="step-registro">
      <h2>Emitir Voto</h2>
      <div class="info-badge"><p>Selecciona tu apartamento para registrar tu asistencia</p></div>
      <div class="form-group">
        <label>Apartamento</label>
        <select id="apartamento"><option value="">-- Selecciona --</option></select>
      </div>
      <button class="btn" onclick="registrar()">Registrar Asistencia</button>
    </div>
    
    <!-- STEP 2: Votacion -->
    <div class="step" id="step-votacion">
      <h2>Votacion</h2>
      <div id="votacionInfo"></div>
      <div id="opcionesContainer" class="opciones-voto" style="display:none;"></div>
      <button class="btn" id="btnVotar" onclick="votar()" disabled style="display:none;">Enviar Voto</button>
      <div id="resultadosLive" style="display:none;margin-top:20px;">
        <h3 style="color:#6B2FA0;margin-bottom:15px;">Resultados en Tiempo Real</h3>
        <div id="resultadosContent"></div>
      </div>
    </div>
    
    <!-- STEP 3: Confirmacion -->
    <div class="step" id="step-confirmacion">
      <div class="success-message">
        <div class="success-icon">&#10003;</div>
        <h2>Voto Registrado</h2>
        <p>Tu voto ha sido registrado exitosamente</p>
        <h3 style="color:#6B2FA0;margin-top:30px;">Resultados Actuales</h3>
        <div id="resultadosFinal" class="resultados"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, onValue, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

// USA LA MISMA CONFIG QUE EL SISTEMA DE ASISTENCIA
const firebaseConfig = {
  apiKey: "AIzaSyAFWn-qxIC0o6A0f5BBzdJe0NM2UgGP-88",
  authDomain: "azeche-ph.firebaseapp.com",
  databaseURL: "https://azeche-ph-default-rtdb.firebaseio.com",
  projectId: "azeche-ph",
  storageBucket: "azeche-ph.firebasestorage.app",
  messagingSenderId: "650847232355",
  appId: "1:650847232355:web:8a84be8775e96ce03a0e15"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const params = new URLSearchParams(window.location.search);
const edificio = params.get('edificio') || 'nepal-2';

const nombresEdificios = {
  'nepal-2': 'NEPAL 2',
  'avalon': 'AVALON',
  'convivienda-1': 'CONVIVIENDA 1',
  'pinos-del-country': 'PINOS DEL COUNTRY'
};

document.getElementById('edificioNombre').textContent = nombresEdificios[edificio] || edificio.toUpperCase();

let votoSeleccionado = null;
let usuarioId = null;
let votacion = null;
let coeficiente = 0;

// Cargar propietarios IGUAL que asistencia
async function cargarPropietarios() {
  try {
    const snap = await get(ref(db, `propietarios/${edificio}`));
    const data = snap.val();
    if (data) {
      const select = document.getElementById('apartamento');
      Object.entries(data)
        .sort((a, b) => (parseInt(a[1].apto) || 0) - (parseInt(b[1].apto) || 0))
        .forEach(([key, prop]) => {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = `Apto ${prop.apto} - ${prop.nombre || 'Propietario'}`;
          opt.dataset.apto = prop.apto;
          opt.dataset.coeficiente = prop.coeficiente || 0;
          select.appendChild(opt);
        });
    }
  } catch (e) {
    console.error('Error:', e);
  }
}

// Escuchar votacion activa EN TIEMPO REAL
onValue(ref(db, `asambleas/${edificio}/votacion_activa`), (snap) => {
  votacion = snap.val();
  console.log('VOTACION:', votacion);
  if (votacion) {
    mostrarVotacion();
    actualizarResultados();
  } else {
    document.getElementById('votacionInfo').innerHTML = '<div class="waiting-msg"><p>Esperando votacion...</p><p>El administrador aun no ha abierto una votacion</p></div>';
    document.getElementById('opcionesContainer').style.display = 'none';
    document.getElementById('btnVotar').style.display = 'none';
  }
});

cargarPropietarios();

window.registrar = async function() {
  const select = document.getElementById('apartamento');
  const key = select.value;
  if (!key) { alert('Selecciona tu apartamento'); return; }
  
  const opt = select.options[select.selectedIndex];
  coeficiente = parseFloat(opt.dataset.coeficiente) || 0;
  
  try {
    usuarioId = key;
    await set(ref(db, `asambleas/${edificio}/asistentes/${key}`), {
      apartamento: opt.dataset.apto,
      nombre: opt.textContent.replace('Apto ', ''),
      coeficiente: coeficiente,
      horaRegistro: new Date().toISOString()
    });
    document.getElementById('step-registro').classList.remove('active');
    document.getElementById('step-votacion').classList.add('active');
  } catch (e) {
    console.error('Error:', e);
    alert('Error: ' + e.message);
  }
};

function mostrarVotacion() {
  if (!votacion) return;
  
  const tipo = votacion.tipo === 'nominal' ? 'Nominal' : 'Por Coeficientes';
  document.getElementById('votacionInfo').innerHTML = `
    <div class="votacion-card">
      <h3>${votacion.titulo || 'Votacion'}</h3>
      <p>${votacion.descripcion || ''}</p>
      <span class="tipo-info">${tipo}</span>
    </div>`;
  
  const container = document.getElementById('opcionesContainer');
  container.innerHTML = '';
  container.style.display = 'grid';
  document.getElementById('btnVotar').style.display = 'block';
  
  // Las opciones deben estar en votacion.opciones
  const opciones = votacion.opciones;
  if (opciones) {
    Object.entries(opciones)
      .sort((a, b) => (a[1].orden || 0) - (b[1].orden || 0))
      .forEach(([k, opt], i) => {
        const div = document.createElement('div');
        div.className = 'opcion-voto';
        div.innerHTML = `<div class="opcion-numero">${i+1}</div><span>${opt.label}</span>`;
        div.onclick = function() {
          votoSeleccionado = k;
          document.querySelectorAll('.opcion-voto').forEach(el => el.classList.remove('selected'));
          this.classList.add('selected');
          document.getElementById('btnVotar').disabled = false;
        };
        container.appendChild(div);
      });
  }
  
  votoSeleccionado = null;
  document.getElementById('btnVotar').disabled = true;
}

window.votar = async function() {
  if (!votoSeleccionado || !usuarioId) { alert('Selecciona una opcion'); return; }
  
  try {
    const existe = await get(ref(db, `asambleas/${edificio}/votacion_activa/votos/${usuarioId}`));
    if (existe.exists()) { alert('Ya registraste tu voto'); return; }
    
    await set(ref(db, `asambleas/${edificio}/votacion_activa/votos/${usuarioId}`), {
      opcion: votoSeleccionado,
      coeficiente: coeficiente || 0,
      hora: new Date().toISOString()
    });
    
    document.getElementById('step-votacion').classList.remove('active');
    document.getElementById('step-confirmacion').classList.add('active');
    actualizarResultados();
  } catch (e) {
    console.error('Error:', e);
    alert('Error al enviar voto');
  }
};

function actualizarResultados() {
  if (!votacion || !votacion.votos) return;
  
  const votos = votacion.votos;
  const tipo = votacion.tipo || 'coeficientes';
  const opciones = votacion.opciones;
  const colores = ['#9C27B0', '#dc3545', '#ff9800'];
  let html = '';
  
  if (opciones) {
    const conteos = {};
    Object.keys(opciones).forEach(k => conteos[k] = 0);
    
    Object.values(votos).forEach(v => {
      const val = tipo === 'nominal' ? 1 : parseFloat(v.coeficiente || 0);
      if (conteos.hasOwnProperty(v.opcion)) conteos[v.opcion] += val;
    });
    
    let total = 0;
    Object.values(conteos).forEach(v => total += v);
    
    Object.entries(opciones)
      .sort((a, b) => (a[1].orden || 0) - (b[1].orden || 0))
      .forEach(([k, opt], i) => {
        const val = conteos[k] || 0;
        const pct = total > 0 ? (val / total * 100) : 0;
        html += `<div class="resultado-bar">
          <div class="resultado-label"><span>${opt.label}</span><span>${tipo === 'nominal' ? val : val.toFixed(4)} (${pct.toFixed(1)}%)</span></div>
          <div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${colores[i % colores.length]};">${pct.toFixed(1)}%</div></div>
        </div>`;
      });
  }
  
  document.getElementById('resultadosFinal').innerHTML = html;
  document.getElementById('resultadosContent').innerHTML = html;
  document.getElementById('resultadosLive').style.display = 'block';
}
</script>
</body>
</html>